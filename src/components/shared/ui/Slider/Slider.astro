---
import Image from 'astro/components/Image.astro';
import type { ImageMetadata } from 'astro';

interface Props {
  slides: ImageMetadata[];
  class?: string;
}

const { slides, class: className } = Astro.props;
---

<style lang="scss">
  .slider {
    --slider-end-offset: calc(-100% + 169.5px);

    display: flex;
    gap: 16px;
    will-change: transform;
    transition: transform 0.3s ease-out;

    @include media-max($lg) {
      --slider-end-offset: calc(-100% + 145px);
      gap: 10px;
    }

    @include media-max($md) {
      --slider-end-offset: calc(-100% + 110px);
    }

    &__item {
      width: 169.5px;
      display: inline-flex;

      @include media-max($lg) {
        width: 145px;
      }

      @include media-max($md) {
        width: 110px;
      }

      img {
        width: 100%;
        height: 100%;
        border-radius: $border-radius-img;
      }
    }
  }
</style>

<div class:list={['slider', className]}>
  {
    slides.map((slide, index) => (
      <div class="slider__item">
        <Image
          src={slide}
          alt={`Cool place ${index + 1} in London shown in the app image`}
          fetchpriority="high"
        />
      </div>
    ))
  }
</div>

<script>
  const slider = document.querySelector('.slider') as HTMLElement;

  if (slider) {
    const updateSliderPosition = () => {
      const scrollY = window.scrollY;
      const windowHeight = window.innerHeight;

      const startScroll = 0;
      // Animation ends at 85% of viewport height to finish before element exits
      const endScroll = windowHeight * 0.85;

      let progress = 0;

      if (scrollY >= startScroll && scrollY <= endScroll) {
        progress = (scrollY - startScroll) / (endScroll - startScroll);
        progress = Math.max(0, Math.min(1, progress));
      } else if (scrollY > endScroll) {
        progress = 1;
      }

      const endOffsetStr = getComputedStyle(slider).getPropertyValue('--slider-end-offset').trim();
      slider.style.transform = `translateX(calc(${endOffsetStr} * ${progress}))`;
    };

    // Update on scroll
    window.addEventListener('scroll', updateSliderPosition, { passive: true });

    // Initial update
    updateSliderPosition();

    // Cleanup on page navigation (for Astro view transitions)
    document.addEventListener('astro:before-preparation', () => {
      window.removeEventListener('scroll', updateSliderPosition);
    });
  }
</script>
